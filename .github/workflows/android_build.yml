name: Build Windows x64

on:
  workflow_dispatch: 

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.x"
          cache: true

      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      - name: Get Dependencies
        run: |
          cd simple_live_app
          flutter pub get

      - name: Build Windows
        run: |
          cd simple_live_app
          flutter build windows --release

      - name: Locate and Package Windows Build
        shell: pwsh
        run: |
          Write-Host "Searching for build output..."
          # 打印现有的 Release 目录位置
          Get-ChildItem -Path . -Recurse -Directory -Filter "Release" | Select-Object FullName
          
          $possiblePaths = @(
              "simple_live_app\build\windows\x64\runner\Release",
              "simple_live_app\build\windows\runner\Release",
              "build\windows\x64\runner\Release"
          )

          $foundPath = $null
          foreach ($path in $possiblePaths) {
              if (Test-Path $path) {
                  $foundPath = $path
                  break
              }
          }

          if ($foundPath) {
              Write-Host "Success! Found build at: $foundPath"
              Compress-Archive -Path "$foundPath\*" -DestinationPath "simple_live_win_x64.zip"
          } else {
              Write-Host "Could not find standard paths. Listing directory structure:"
              Get-ChildItem -Recurse | Select-Object FullName
              exit 1
          }

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: simple_live_win_x64
          path: simple_live_win_x64.zip
